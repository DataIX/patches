# HG changeset patch
# Parent 13d344bb0d26ee460848459757022ea4487916f3
In userland, sign extend the offset for JA instructions. (libpcap)

diff -r 13d344bb0d26 contrib/libpcap/bpf/net/bpf_filter.c
--- a/contrib/libpcap/bpf/net/bpf_filter.c
+++ b/contrib/libpcap/bpf/net/bpf_filter.c
@@ -396,7 +396,18 @@
 			continue;
 
 		case BPF_JMP|BPF_JA:
+#if defined(KERNEL) || defined(_KERNEL)
+	/*
+ 	 * No backward jumps allowed.
+	 */
 			pc += pc->k;
+#else
+	/*
+	 * XXX - we currently implement "ip6 protochain"
+	 * with backward jumps, so sign-extend pc->k.
+	 */
+			pc += (bpf_int32)pc->k;
+#endif
 			continue;
 
 		case BPF_JMP|BPF_JGT|BPF_K:
