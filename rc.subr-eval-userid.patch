# HG changeset patch
# Parent 1486bb0cc1aa1f77f9c722c8df7bd7eb6b6e6eb2
Patch up ID and eval calls

diff -r 1486bb0cc1aa etc/rc.subr
--- a/etc/rc.subr
+++ b/etc/rc.subr
@@ -46,8 +46,7 @@
 SYSCTL="/sbin/sysctl"
 SYSCTL_N="${SYSCTL} -n"
 SYSCTL_W="${SYSCTL}"
-ID="/usr/bin/id"
-IDCMD="if [ -x $ID ]; then $ID -un; fi"
+ID=$(test -x /usr/bin/ids && /usr/bin/id -un)
 PS="/bin/ps -ww"
 JID=`$PS -p $$ -o jid=`
 
@@ -677,10 +676,9 @@
 	    _nice=\$${name}_nice	_user=\$${name}_user \
 	    _group=\$${name}_group	_groups=\$${name}_groups
 
-	if [ -n "$_user" ]; then	# unset $_user if running as that user
-		if [ "$_user" = "$(eval $IDCMD)" ]; then
-			unset _user
-		fi
+	# unset $_user if running as that user
+	if [ -n "$_user" -a "$_user" = "$ID" ]; then
+		unset _user
 	fi
 
 	eval $_pidcmd			# determine the pid if necessary
@@ -1076,7 +1074,7 @@
 
 	# Set defaults if defined.
 	for _var in $rcvar $rcvars; do
-		_defval=`eval echo "\\\$${_var}_defval"`
+		eval _defval=\$${_var}_defval
 		if [ -n "$_defval" ]; then
 			eval : \${$_var:=\$${_var}_defval}
 		fi
@@ -1084,9 +1082,9 @@
 
 	# check obsolete rc.conf variables
 	for _var in $rcvars_obsolete; do
-		_v=`eval echo \\$$_var`
-		_msg=`eval echo \\$${_var}_obsolete_msg`
-		_new=`eval echo \\$${_var}_newvar`
+		eval _v=\$$_var
+		eval _msg=\$${_var}_obsolete_msg
+		eval _new=\$${_var}_newvar
 		case $_v in
 		"")
 			;;
